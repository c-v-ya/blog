{"componentChunkName":"component---src-templates-post-template-js","path":"/2020-03-28-str-with-foreign-key","result":{"data":{"markdownRemark":{"frontmatter":{"date":"March 28, 2020","title":"Why ForeignKey reference in Django model's __str__ method is a bad idea","path":"/2020-03-28-str-with-foreign-key"},"html":"<h1>Cutting database queries by not referencing Foreign Keys</h1>\n<p><em>Photo by</em> <a href=\"https://unsplash.com/@othentikisra?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText\"><em>israel palacio</em></a> <em>on</em> <a href=\"https://unsplash.com/@othentikisra?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText\"><em>Unsplash</em></a></p>\n<p>So you have a model with foreign key:</p>\n\n        <deckgo-highlight-code language=\"python\"  theme=\"monokai\" line-numbers=\"true\" >\n          <code slot=\"code\">from django.db import models\nfrom .models import Author\n\nclass Book(models.Model):\n    name = models.CharField(...)\n    author = models.ForeignKey(to=Author,...)</code>\n        </deckgo-highlight-code>\n      \n<p>Now you want to see an <code class=\"language-text\">author</code> in your admin panel. Easy, right? Just add:</p>\n\n        <deckgo-highlight-code language=\"python\"  theme=\"monokai\" line-numbers=\"true\" >\n          <code slot=\"code\">def __str__(self):\n    return f&#39;{self.id} {self.author.name}&#39;</code>\n        </deckgo-highlight-code>\n      \n<p>What this will do is hit our database for an author name for every row present on a page. Imagine there are 100 rows. That's 100 more hits. This problem is known as the <code class=\"language-text\">n+1 query</code>.</p>\n<p>The solution is quiet easy. If that's a <code class=\"language-text\">ForeignKey</code>, you need to use <code class=\"language-text\">select_related</code> on your <code class=\"language-text\">queryset</code>. If that's a <code class=\"language-text\">ManyToMany</code> field, then you need a <code class=\"language-text\">prefetch_related</code> method. And, by the way, that's the difference between those two methods. It's a common interview question.</p>\n<p>But in our case it's not a simple query. If you really want to fix that you would need to dig deeper into how Django admin works and provide custom <code class=\"language-text\">queryset</code> to the view.</p>\n<p>When I encountered this problem the solution that has been accepted was just removing the reference to <code class=\"language-text\">ForeingKey</code> from the <code class=\"language-text\">__str__</code> method ¯\\_(ツ)_/¯</p>\n<p><em>A little ToDo for myself: find a way to solve this via select</em>_<em>related</em>.</p>","timeToRead":1},"file":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIDAQX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB5irqUJC//8QAGhAAAgIDAAAAAAAAAAAAAAAAAQIAERIhMf/aAAgBAQABBQILaBdumLzkJuf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAZEAABBQAAAAAAAAAAAAAAAAABEBESIDH/2gAIAQEABj8CkhGtT//EABkQAQEBAAMAAAAAAAAAAAAAAAERACFBUf/aAAgBAQABPyG50GahPctk9DXidaqo5FV5d//aAAwDAQACAAMAAAAQRA//xAAWEQADAAAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8QhX//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCn/8QAGhABAAMBAQEAAAAAAAAAAAAAAQARIUExgf/aAAgBAQABPxBbIbAvTsulNAfYcwKuDBejZuoEKE0Ync6LP//Z","aspectRatio":1.5023474178403755,"src":"/blog/static/b5d2d568bed9ab8c931f6aa7e96e353d/68386/israel-palacio-ImcUkZ72oUs-unsplash.jpg","srcSet":"/blog/static/b5d2d568bed9ab8c931f6aa7e96e353d/474e4/israel-palacio-ImcUkZ72oUs-unsplash.jpg 320w,\n/blog/static/b5d2d568bed9ab8c931f6aa7e96e353d/3bf7d/israel-palacio-ImcUkZ72oUs-unsplash.jpg 640w,\n/blog/static/b5d2d568bed9ab8c931f6aa7e96e353d/68386/israel-palacio-ImcUkZ72oUs-unsplash.jpg 1280w,\n/blog/static/b5d2d568bed9ab8c931f6aa7e96e353d/097fa/israel-palacio-ImcUkZ72oUs-unsplash.jpg 1920w,\n/blog/static/b5d2d568bed9ab8c931f6aa7e96e353d/2e889/israel-palacio-ImcUkZ72oUs-unsplash.jpg 2560w,\n/blog/static/b5d2d568bed9ab8c931f6aa7e96e353d/a98af/israel-palacio-ImcUkZ72oUs-unsplash.jpg 4096w","sizes":"(max-width: 1280px) 100vw, 1280px"}}}},"pageContext":{"imagePath":"israel-palacio-ImcUkZ72oUs-unsplash.jpg","prev":{"frontmatter":{"path":"/2020-05-06-django-react-redux-jwt","title":"Django + React, Redux and JWT","date":"May 06, 2020","author":"Constantine Yarushkin","description":"On the way to a full stack dev","image":null}},"next":{"frontmatter":{"path":"/2020-03-15-how-I-become-dev","title":"How I Became a Developer","date":"March 15, 2020","author":"Constantine Yarushkin","description":"I was spending two hours on job duties and could read books in the remaining time. But decided to change this.","image":"python.png"}}}}}