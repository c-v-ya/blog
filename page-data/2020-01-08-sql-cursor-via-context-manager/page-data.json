{"componentChunkName":"component---src-templates-post-template-js","path":"/2020-01-08-sql-cursor-via-context-manager","result":{"data":{"markdownRemark":{"frontmatter":{"date":"January 08, 2020","title":"SQL Cursor via Context Manager","path":"/2020-01-08-sql-cursor-via-context-manager","description":"Automatically closing database connection with Context Manager","tags":"python, sql, context manager"},"html":"<h2>Automatically closing database connection with Context Manager</h2>\n<p><em>Photo by</em> <a href=\"https://unsplash.com/@tvick?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText\"><em>Taylor Vick</em></a> <em>on</em> <a href=\"https://unsplash.com/@tvick?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText\"><em>Unsplash</em></a></p>\n<p>If you don't know what a Context Manager is I recommend you to read about them. Dan Bader wrote a good article. But since you are here, why not read <a href=\"https://c-v-ya.github.io/blog/2019-11-04-why-context-manager-is-useful\">my post</a>?</p>\n<p>Now, it's nothing special to write a cursor. You need a driver and credentials to connect to the database. In this example I'll use MySQL driver. My credentials are stored in <code class=\"language-text\">settings.py</code> (not in plain text but environment variables) as a dictionary.</p>\n<p>First, we need to provide a driver and credentials to our cursor:</p>\n\n        <deckgo-highlight-code language=\"python\"  theme=\"monokai\" >\n          <code slot=\"code\">import mysql.connector as connector\n\nfrom settings import DATABASE\n\nclass Cursor:\n    def __init__(self,\n                 host=DATABASE.get(&#39;HOST&#39;),\n                 user=DATABASE.get(&#39;USER&#39;),\n                 password=DATABASE.get(&#39;PASSWORD&#39;),\n                 db_name=DATABASE.get(&#39;NAME&#39;),\n                 driver=connector,\n        ):\n        self.driver = driver\n        self.connection = self.driver.connect(\n                          host=host,\n                          user=user,\n                          password=password,\n                          database=db_name\n        )\n        self.cursor = self.connection.cursor()</code>\n        </deckgo-highlight-code>\n      \n<p>Now we need to provide methods of a Context Manager to our class:</p>\n\n        <deckgo-highlight-code language=\"python\"  theme=\"monokai\" >\n          <code slot=\"code\">class Cursor:\n    def __init__(...)\n    def __enter__(self):\n        return self.cursor\n    def __exit__(self, ext_type, exc_value, traceback):\n        self.cursor.close()\n        if isinstance(exc_value, Exception):\n            self.connection.rollback()\n        else:\n            self.connection.commit()\n        self.connection.close()</code>\n        </deckgo-highlight-code>\n      \n<p>And finally, we need to return something from the database, when it is needed:</p>\n\n        <deckgo-highlight-code language=\"python\"  theme=\"monokai\" >\n          <code slot=\"code\">class Cursor:\n    def __init__(...)\n    def __iter__(self):\n        for item in self.cursor:\n            yield item\n    def __enter__(...)\n    def __exit__(...)</code>\n        </deckgo-highlight-code>\n      \n<p>Done. Usage is a simple <code class=\"language-text\">with Cursor() as cursor:</code></p>\n<p>I've never bothered to simplify it via <code class=\"language-text\">@contextmanager</code> decorator because this implementation works perfectly fine for me. And I'm not sure if we can apply that decorator to a class.</p>\n<p>I'd like to use ORM because it makes things so much easier and faster. But sometimes ORM is an overkill and you need to interact with DB manually.</p>\n<p>Hope you find this helpful if you ever need to write a custom Cursor.</p>","timeToRead":2},"file":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEAf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAGHJyGEK//EABgQAQADAQAAAAAAAAAAAAAAAAEAAhEg/9oACAEBAAEFAqoRts3j/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAAAEg/9oACAEBAAY/Ahz/AP/EABsQAAIBBQAAAAAAAAAAAAAAAAEQEQAxQVGR/9oACAEBAAE/ITgtMaoWDiB//9oADAMBAAIAAwAAABA7z//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/EKf/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCH/8QAGhABAAIDAQAAAAAAAAAAAAAAAQARECExYf/aAAgBAQABPxBkLJdtHGg28BgkdMVp9cf/2Q==","aspectRatio":1.7777777777777777,"src":"/blog/static/33a052933231d8fbb5b77fc851ddae07/68386/taylor-vick-M5tzZtFCOfs-unsplash.jpg","srcSet":"/blog/static/33a052933231d8fbb5b77fc851ddae07/474e4/taylor-vick-M5tzZtFCOfs-unsplash.jpg 320w,\n/blog/static/33a052933231d8fbb5b77fc851ddae07/3bf7d/taylor-vick-M5tzZtFCOfs-unsplash.jpg 640w,\n/blog/static/33a052933231d8fbb5b77fc851ddae07/68386/taylor-vick-M5tzZtFCOfs-unsplash.jpg 1280w,\n/blog/static/33a052933231d8fbb5b77fc851ddae07/097fa/taylor-vick-M5tzZtFCOfs-unsplash.jpg 1920w,\n/blog/static/33a052933231d8fbb5b77fc851ddae07/dd7a5/taylor-vick-M5tzZtFCOfs-unsplash.jpg 1925w","sizes":"(max-width: 1280px) 100vw, 1280px"}}}},"pageContext":{"imagePath":"taylor-vick-M5tzZtFCOfs-unsplash.jpg","prev":{"frontmatter":{"path":"/2020-03-15-how-I-become-dev","title":"How I Became a Developer","date":"March 15, 2020","author":"Constantine Yarushkin","description":"I was spending two hours on job duties and could read books in the remaining time. But decided to change this.","image":"python.png","tags":"python, django, career"}},"next":{"frontmatter":{"path":"/2019-11-04-why-context-manager-is-useful","title":"Why Context Manager is useful","date":"November 04, 2019","author":"Constantine Yarushkin","description":"How not to think about consequences when acquiring resources","image":"efe-yagiz-soysal-XcJDpwrbMyg-unsplash.jpg","tags":"python, sql, context manager, beginners"}}}}}