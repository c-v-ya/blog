{"componentChunkName":"component---src-templates-post-template-js","path":"/2021-02-07-monitoring","result":{"data":{"markdownRemark":{"frontmatter":{"date":"February 07, 2021","title":"Monitoring Apps with Docker Containers","path":"/2021-02-07-monitoring","description":"Connecting containers together","tags":"docker"},"html":"<p><em>Photo by</em> <a href=\"https://unsplash.com/@ibrahimboran?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText\"><em>Ibrahim Boran</em></a> <em>on</em> <a href=\"https://unsplash.com/?utm_source=unsplash&#x26;utm_medium=referral&#x26;utm_content=creditCopyText\"><em>Unsplash</em></a></p>\n<p>I already <a href=\"https://dev.to/c_v_ya/dockerizing-stuff-you-need-3b7m\">wrote</a> about my flow when I deploy one container per service and use it for all of my projects. So it's easier to get a development process up to speed.</p>\n<p>This time I'll tell you about connecting containerized services so they can talk to each other. And we'll start with somewhat easy things like <a href=\"https://prometheus.io/\">Prometheus</a> and <a href=\"https://grafana.com/\">Grafana</a>. And after that it will be a no-brainer for us to spin up an <a href=\"https://www.elastic.co/what-is/elk-stack\">ELK</a> stack. Let's go! 🚀</p>\n<h1>Side Note</h1>\n<p>All code examples and configs are available on my GitHub <a href=\"https://github.com/c-v-ya/con-con\">repo</a>.</p>\n<h1>Metrics</h1>\n<p>If you didn't know what Prometheus is used for - it collects various metrics from a service. And a little side thing we need to do before setting up our <a href=\"https://en.wikipedia.org/wiki/Prometheus\">God of Fire</a> is to create a service we'll be monitoring. I chose it to be a simple Flask app because it requires almost zero efforts.</p>\n<h2>Flask App</h2>\n<p>Create a <code class=\"language-text\">flask_app</code> directory and put next two files there:</p>\n\n        <deckgo-highlight-code language=\"python\"  theme=\"monokai\" >\n          <code slot=\"code\"># flask_app/app.py\nfrom flask import Flask\nfrom prometheus_flask_exporter import PrometheusMetrics\n\napp = Flask(__name__)\nmetrics = PrometheusMetrics(app)</code>\n        </deckgo-highlight-code>\n      \n\n        <deckgo-highlight-code language=\"python\"  theme=\"monokai\" >\n          <code slot=\"code\"># flask_app/wsgi.py\nfrom app import app</code>\n        </deckgo-highlight-code>\n      \n<p>Also create <code class=\"language-text\">requirements.txt</code> right next to previous two:</p>\n\n        <deckgo-highlight-code   theme=\"monokai\" >\n          <code slot=\"code\">click==7.1.2\nFlask==1.1.2\nitsdangerous==1.1.0\nJinja2==2.11.3\nMarkupSafe==1.1.1\nprometheus-client==0.9.0\nprometheus-flask-exporter==0.18.1\nWerkzeug==1.0.1</code>\n        </deckgo-highlight-code>\n      \n<p>Then create <code class=\"language-text\">Dockerfile</code>, same place:</p>\n\n        <deckgo-highlight-code language=\"Dockerfile\"  theme=\"monokai\" >\n          <code slot=\"code\">FROM python:3.9\n\nENV PYTHONUNBUFFERED 1\nENV PYTHONDONTWRITEBYTECODE 1\n\nEXPOSE 8000\n\nRUN apt-get update \\\n  &amp;&amp; apt-get install -y build-essential \\\n  &amp;&amp; apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \\\n  &amp;&amp; apt-get clean -y &amp;&amp; rm -rf /var/lib/apt/lists/* \\\n  &amp;&amp; pip install --upgrade pip\n\nWORKDIR /app\nCOPY requirements.txt .\nRUN pip install -r requirements.txt\n\nCOPY . .\n\nENTRYPOINT [&quot;gunicorn&quot;, &quot;wsgi:app&quot;, &quot;--bind&quot;, &quot;0.0.0.0:8000&quot;]</code>\n        </deckgo-highlight-code>\n      \n<p>That's quite mouthful but all it does is:</p>\n<ul>\n<li>creating an image from python 3.9;</li>\n<li>opens up port 8000;</li>\n<li>updates everything;</li>\n<li>and installs our great app.</li>\n</ul>\n<p>Now we build!</p>\n\n        <deckgo-highlight-code   theme=\"monokai\" >\n          <code slot=\"code\">docker build . -t flask_app</code>\n        </deckgo-highlight-code>\n      \n<p>And now we run!!</p>\n\n        <deckgo-highlight-code   theme=\"monokai\" >\n          <code slot=\"code\">docker run -d -p 8000:8000 flask_app --name flask_app</code>\n        </deckgo-highlight-code>\n      \n<p>And on <a href=\"http://0.0.0.0:8000/metrics\">http://0.0.0.0:8000/metrics</a> we can see a bunch of stuff!!1 💪</p>\n<h2>Prometheus</h2>\n<p>It's time to start metering. Open <del>my</del> our favorite tool to manage containers - <a href=\"https://www.portainer.io/\">Portainer</a>. And first, create a volume. Actually, two volumes. If you've read my previous article you know how it goes. But in case you didn't (why didn't you tho?) - go to \"Volumes\" tab and hit that blue \"Add volume\" button. First volume will be used for Prometheus data. So let's name it <code class=\"language-text\">prometheus_data</code>. Second will be used for Prometheus config, therefore the name <code class=\"language-text\">prometheus_config_data</code>.</p>\n<p>\"Why data for config?\" you might ask. Well, because apparently you can't access the Prometheus container via the Portainer console button. Or I'm just stupid 🤷‍♂️ But we need a way to edit config files without rebuilding container every time. Thus volume for config files.</p>\n<p>Creating container, finally. Go to \"Containers\" and smash the \"Add container\" button. Then look at the screenshot below and fill values for Name, Image, Ports and Volumes. Maybe change Restart Policy to Unless stopped.</p>\n<p><img src=\"https://dev-to-uploads.s3.amazonaws.com/i/cabzkava29o452v2picn.png\" alt=\"Prometheus create container\"></p>\n<p>Then hit the \"Deploy the container\" button and wait a little.</p>\n<h2>Configure Prometheus</h2>\n<p>Since we <del>don't know how to</del> can't connect to a Prometheus container we will edit it's config file via terminal session. If you're using <a href=\"https://nano.org/\">nano</a> like I do then just execute next line and make it look the same as below:</p>\n\n        <deckgo-highlight-code   theme=\"monokai\" >\n          <code slot=\"code\">sudo nano /var/lib/docker/volumes/prometheus_config_data/_data/prometheus.yml</code>\n        </deckgo-highlight-code>\n      \n\n        <deckgo-highlight-code   theme=\"monokai\" >\n          <code slot=\"code\"># my global config\nglobal:\n  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets:\n      # - alertmanager:9093\n\n# Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.\nrule_files:\n  # - &quot;first_rules.yml&quot;\n  # - &quot;second_rules.yml&quot;\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it&#39;s Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.\n  - job_name: &#39;prometheus&#39;\n\n    # metrics_path defaults to &#39;/metrics&#39;\n    # scheme defaults to &#39;http&#39;.\n\n    static_configs:\n    - targets: [&#39;localhost:9090&#39;]\n\n  - job_name: &#39;flask_app&#39;\n    metrics_path: &#39;/metrics&#39;\n    static_configs:\n    - targets: [&#39;172.17.0.1:8000&#39;]</code>\n        </deckgo-highlight-code>\n      \n<p>It's the same default config but with additional <code class=\"language-text\">job_name</code> at the end. I decided to be explicit with <code class=\"language-text\">metrics_path</code> here, showing that we can change that if we need to. But <strong>the most important part</strong> is <code class=\"language-text\">targets</code>! You can just believe me that on Linux your host machine's IP address will be <code class=\"language-text\">172.17.0.1</code> for your docker containers. Or you can visit a \"Network\" tab in Portainer and take a look at \"IPV4 IPAM Gateway\" for a <code class=\"language-text\">bridge</code> interface.</p>\n<p>Now restart Prometheus container and visit <a href=\"http://0.0.0.0:9090/targets\">http://0.0.0.0:9090/targets</a>. You should see \"State\" <code class=\"language-text\">UP</code> for both targets.</p>\n<p>If we refresh our Great Flask App that serves us 404 on <a href=\"http://0.0.0.0:8000/\">http://0.0.0.0:8000/</a> and then go to <a href=\"http://0.0.0.0:9090/graph?g0.expr=flask_http_request_total&#x26;g0.tab=0&#x26;g0.stacked=0&#x26;g0.range_input=1h\">graph</a> for total requests, we should see.. well.. a graph for total requests.</p>\n<p>Cool, eh? Let's make it beautiful! 🐹</p>\n<h2>Grafana</h2>\n<p>Again, create a volume, for example <code class=\"language-text\">grafana_data</code>. Then create container as on screenshot below</p>\n<p><img src=\"https://raw.githubusercontent.com/c-v-ya/con-con/master/screenshots/Grafana.png\" alt=\"Grafana create container\" title=\"Grafana create container\"></p>\n<p>Hit deploy, wait and go to <a href=\"http://0.0.0.0:3000/\">http://0.0.0.0:3000/</a>. Default login/password is admin/admin. You can change that after login.</p>\n<p>Configure data source on <a href=\"http://0.0.0.0:3000/datasources\">http://0.0.0.0:3000/datasources</a>. Or locate \"Data Sources\" tab hovering on ⚙ sign on the left. Then click the blue \"Add data source\" button, select \"Prometheus\". <strong>Very important</strong>, as before, \"URL\" parameter inside the \"HTTP\" section should be <code class=\"language-text\">172.17.0.1:9090</code>. Because Grafana can't access Prometheus container by host name. So we tell it (her?) to connect to our host machine IP address on the port where Prometheus is running. Then smash \"Save &#x26; Test\". As always, you can try to set \"URL\" to <code class=\"language-text\">prometheus_container_name:port</code> and after saving observe \"HTTP Error Bad Gateway\".</p>\n<p>Now we can hover over ➕ sign and click on \"Dashboard\" under \"Create\". Or just visit <a href=\"http://0.0.0.0:3000/dashboard/new\">http://0.0.0.0:3000/dashboard/new</a>. Then smash \"Add new panel\". On the right side change \"Title\" to whatever your heart desires. I chose simple \"Flask Total Requests\". Below graph set \"Metrics\" to <code class=\"language-text\">flask_http_request_total</code>. Here is a handy screenshot for you:</p>\n<p><img src=\"https://raw.githubusercontent.com/c-v-ya/con-con/master/screenshots/Grafana-Dashboard.png\" alt=\"Grafana create dashboard\" title=\"Grafana create dashboard\"></p>\n<p>Then click \"Apply\" in the top right corner. And now you have Grafana which makes beautiful graphs from Prometheus data which monitors your application!</p>\n<p>In the <a href=\"https://dev.to/c_v_ya/setting-up-local-elk-stack-2708\">next article</a> we will set up ELK. But I guess you already know how to do that 😉</p>","timeToRead":6},"file":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAv/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABjZE25wLD/8QAGRAAAwEBAQAAAAAAAAAAAAAAAAECERIx/9oACAEBAAEFApdWU5Y/ZeHTw//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABwQAAEDBQAAAAAAAAAAAAAAAAEAAhEgITEyUf/aAAgBAQAGPwLfHVBdcU//xAAbEAADAQADAQAAAAAAAAAAAAABESEAEDFBUf/aAAgBAQABPyEuLCKt4Ku/uQwZiExrGjx//9oADAMBAAIAAwAAABAUP//EABYRAQEBAAAAAAAAAAAAAAAAAAABEf/aAAgBAwEBPxCVr//EABYRAQEBAAAAAAAAAAAAAAAAAAABEf/aAAgBAgEBPxCxj//EAB0QAQEAAgEFAAAAAAAAAAAAAAERACFRMUFxgdH/2gAIAQEAAT8QoWlKaOTeHKGhTfT5jRPhgOFvfxliBXomLVYGf//Z","aspectRatio":1.6326530612244898,"src":"/blog/static/3d70461f01f34d5f8a20223fca29ee8f/68386/ibrahim-boran-iYkqHp5cGQ4-unsplash.jpg","srcSet":"/blog/static/3d70461f01f34d5f8a20223fca29ee8f/474e4/ibrahim-boran-iYkqHp5cGQ4-unsplash.jpg 320w,\n/blog/static/3d70461f01f34d5f8a20223fca29ee8f/3bf7d/ibrahim-boran-iYkqHp5cGQ4-unsplash.jpg 640w,\n/blog/static/3d70461f01f34d5f8a20223fca29ee8f/68386/ibrahim-boran-iYkqHp5cGQ4-unsplash.jpg 1280w,\n/blog/static/3d70461f01f34d5f8a20223fca29ee8f/097fa/ibrahim-boran-iYkqHp5cGQ4-unsplash.jpg 1920w","sizes":"(max-width: 1280px) 100vw, 1280px"}}}},"pageContext":{"imagePath":"ibrahim-boran-iYkqHp5cGQ4-unsplash.jpg","prev":{"frontmatter":{"path":"/2021-02-17-elk","title":"Setting Up Local ELK Stack","date":"February 17, 2021","author":"Constantine Yarushkin","description":"Taming ElasticSearch, Logstash and Kibana","image":"chandler-cruttenden-sDrnyCEAAiI-unsplash.jpg","tags":"docker"}},"next":{"frontmatter":{"path":"/2020-12-25-dockerizing","title":"Dockerizing stuff you need","date":"December 25, 2020","author":"Constantine Yarushkin","description":"Fast set up for local development","image":"dominik-luckmann-SInhLTQouEk-unsplash.jpg","tags":"docker"}}}}}